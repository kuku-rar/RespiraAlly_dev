{
  "meta": {
    "version": "v1.0-refactoring",
    "generated_at": "2025-11-03T04:26:00Z",
    "total_tasks": 18,
    "total_hours": 236,
    "completed_tasks": 0,
    "completed_hours": 0,
    "progress_percentage": 0.0,
    "current_phase": "phase_0",
    "philosophy": "Linus Torvalds Pragmatic Refactoring",
    "source": "docs/refactoring_plan.md"
  },
  "todos": [
    {
      "id": "0.1",
      "phase": "phase_0",
      "phase_name": "建立安全網 (Safety Net)",
      "title": "編寫 OpenAPI 契約規格 (所有現有 API)",
      "description": "為所有現有的 API 端點編寫完整的 OpenAPI/Swagger 規格文件。每個參數、每個響應欄位都必須被精確記錄。涵蓋：/auth, /patients, /daily_metrics, /questionnaires, /overview, /voice, /tasks 等所有端點。",
      "owner": "Backend + API Spec Writer",
      "estimated_hours": 16,
      "actual_hours": 0,
      "status": "pending",
      "priority": "P0",
      "blocking": true,
      "target_date": "Week 1",
      "completed_date": null,
      "dependencies": [],
      "blocked_by": [],
      "blocking_tasks": ["0.2", "0.3", "0.4"],
      "acceptance_criteria": [
        "所有現有 API 端點都有 OpenAPI 規格",
        "包含請求/響應的完整 Schema 定義",
        "包含錯誤碼與異常響應"
      ],
      "tags": ["api", "documentation", "safety-net"],
      "notes": "這是重構的第一步，絕對不可跳過。使用 openapi.yaml 或 Swagger UI。",
      "linus_principle": "Never Break APIs - 必須先知道 API 長什麼樣才能保護它"
    },
    {
      "id": "0.2",
      "phase": "phase_0",
      "phase_name": "建立安全網 (Safety Net)",
      "title": "建立 API 契約測試套件 (pytest + HTTP)",
      "description": "使用 pytest 編寫一套完整的 API 契約測試。直接透過 HTTP 呼叫每個 API 端點，並嚴格驗證其返回的 JSON 是否與 OpenAPI 規格完全一致。這套測試將成為 CI/CD 的一部分。",
      "owner": "QA + Backend",
      "estimated_hours": 24,
      "actual_hours": 0,
      "status": "pending",
      "priority": "P0",
      "blocking": true,
      "target_date": "Week 1-2",
      "completed_date": null,
      "dependencies": ["0.1"],
      "blocked_by": [],
      "blocking_tasks": ["1.1", "1.2", "1.3"],
      "acceptance_criteria": [
        "API 契約測試覆蓋率 = 100%",
        "所有測試通過",
        "測試可在 Docker 環境中獨立執行"
      ],
      "tags": ["testing", "api", "safety-net", "pytest"],
      "notes": "使用 pytest + requests 直接測試 HTTP API。參考：tests/test_api_contracts.py",
      "linus_principle": "測試是安全網，沒有安全網就不准跳傘（重構）"
    },
    {
      "id": "0.3",
      "phase": "phase_0",
      "phase_name": "建立安全網 (Safety Net)",
      "title": "整合 API 契約測試到 CI/CD",
      "description": "將 API 契約測試整合到 CI/CD 流程中。每次 git push 都自動執行測試。如果測試失敗，拒絕合併。",
      "owner": "DevOps",
      "estimated_hours": 4,
      "actual_hours": 0,
      "status": "pending",
      "priority": "P0",
      "blocking": true,
      "target_date": "Week 2",
      "completed_date": null,
      "dependencies": ["0.2"],
      "blocked_by": [],
      "blocking_tasks": ["1.1"],
      "acceptance_criteria": [
        "CI/CD 流程包含 API 契約測試",
        "測試失敗會阻止合併",
        "測試報告清晰可讀"
      ],
      "tags": ["ci-cd", "automation", "devops"],
      "notes": "可使用 GitHub Actions 或現有的 CI 工具。",
      "linus_principle": "自動化是懶人的美德，也是品質的保證"
    },
    {
      "id": "0.4",
      "phase": "phase_0",
      "phase_name": "建立安全網 (Safety Net)",
      "title": "驗證安全網完整性",
      "description": "Tech Lead 親自驗證安全網的完整性。確認所有 API 都有測試，所有測試都通過。這是 Phase 0 的出口檢查點。",
      "owner": "Tech Lead",
      "estimated_hours": 4,
      "actual_hours": 0,
      "status": "pending",
      "priority": "P0",
      "blocking": true,
      "target_date": "Week 2",
      "completed_date": null,
      "dependencies": ["0.3"],
      "blocked_by": [],
      "blocking_tasks": ["1.1"],
      "acceptance_criteria": [
        "API 契約測試覆蓋率 = 100%",
        "所有測試通過",
        "Tech Lead 簽核確認"
      ],
      "tags": ["validation", "checkpoint"],
      "notes": "Phase 0 完成前，不允許進入 Phase 1。",
      "linus_principle": "在你有降落傘之前，不要從飛機上跳下來"
    },

    {
      "id": "1.1",
      "phase": "phase_1",
      "phase_name": "清理 Web-App 核心",
      "title": "建立純領域物件 (Patient, DailyMetric, Questionnaire)",
      "description": "在 app/core/domain/ 目錄下建立純粹的 Python 類別來代表核心資料。這些類別不應該知道資料庫的存在，不依賴 SQLAlchemy。範例：class Patient, class DailyMetric, class Questionnaire, class RiskLevel 等。",
      "owner": "Backend",
      "estimated_hours": 16,
      "actual_hours": 0,
      "status": "pending",
      "priority": "P0",
      "blocking": false,
      "target_date": "Week 3",
      "completed_date": null,
      "dependencies": ["0.4"],
      "blocked_by": [],
      "blocking_tasks": ["1.2"],
      "acceptance_criteria": [
        "建立 app/core/domain/ 目錄",
        "Patient, DailyMetric, Questionnaire 等核心類別完成",
        "零 SQLAlchemy 依賴",
        "包含基本屬性與 getter 方法"
      ],
      "tags": ["domain-model", "refactoring", "ddd-pragmatic"],
      "notes": "參考 refactoring_plan.md 第 1 步。這些是純 Python 類別，可以輕鬆進行單元測試。",
      "linus_principle": "Data Structures First - 好的程式設計師擔心資料結構"
    },
    {
      "id": "1.2",
      "phase": "phase_1",
      "phase_name": "清理 Web-App 核心",
      "title": "建立 Repository 層 (ORM ↔ 領域物件轉換)",
      "description": "建立 Repository 層來負責 SQLAlchemy ORM 模型與純領域物件之間的轉換。範例：PatientRepository, DailyMetricRepository, QuestionnaireRepository。Repository 負責資料庫操作，並將結果轉換為領域物件返回。",
      "owner": "Backend",
      "estimated_hours": 20,
      "actual_hours": 0,
      "status": "pending",
      "priority": "P0",
      "blocking": false,
      "target_date": "Week 3-4",
      "completed_date": null,
      "dependencies": ["1.1"],
      "blocked_by": [],
      "blocking_tasks": ["1.3"],
      "acceptance_criteria": [
        "建立 PatientRepository, DailyMetricRepository 等",
        "實現 to_domain() 和 to_db() 轉換方法",
        "Repository 返回領域物件而非 ORM 模型",
        "Repository 單元測試覆蓋率 > 80%"
      ],
      "tags": ["repository", "refactoring", "data-layer"],
      "notes": "Repository 是領域層與持久化層之間的橋樑。使用 Mapper 模式。",
      "linus_principle": "關注點分離 - 領域邏輯不應該知道資料庫細節"
    },
    {
      "id": "1.3",
      "phase": "phase_1",
      "phase_name": "清理 Web-App 核心",
      "title": "重構 patient_service (使用新領域物件)",
      "description": "重構 patient_service.py，使其接收和返回純領域物件（Patient），而不是 SQLAlchemy 模型。Service 層透過 Repository 與資料庫互動。",
      "owner": "Backend",
      "estimated_hours": 16,
      "actual_hours": 0,
      "status": "pending",
      "priority": "P0",
      "blocking": false,
      "target_date": "Week 4",
      "completed_date": null,
      "dependencies": ["1.2"],
      "blocked_by": [],
      "blocking_tasks": ["1.4"],
      "acceptance_criteria": [
        "patient_service 使用 PatientRepository",
        "Service 方法接收/返回領域物件",
        "API 層保持不變（透過 Mapper 轉換為 DTO）",
        "API 契約測試全部通過"
      ],
      "tags": ["service-layer", "refactoring"],
      "notes": "這是關鍵步驟。確保 API 層的變更是零（透過 Mapper 轉 DTO）。",
      "linus_principle": "Never Break APIs - 內部重構不影響外部介面"
    },
    {
      "id": "1.4",
      "phase": "phase_1",
      "phase_name": "清理 Web-App 核心",
      "title": "將業務邏輯內聚到領域物件 (如 calculate_risk)",
      "description": "將與特定領域物件緊密相關的業務邏輯（例如計算病患風險分數）移到領域物件自身的方法中。範例：patient.calculate_risk() 而非 service 中的獨立函式。這讓物件的行為更加內聚。",
      "owner": "Backend",
      "estimated_hours": 12,
      "actual_hours": 0,
      "status": "pending",
      "priority": "P1",
      "blocking": false,
      "target_date": "Week 4-5",
      "completed_date": null,
      "dependencies": ["1.3"],
      "blocked_by": [],
      "blocking_tasks": ["1.5"],
      "acceptance_criteria": [
        "Patient.calculate_risk() 方法實現",
        "Questionnaire.calculate_score() 方法實現",
        "業務邏輯從 Service 移到領域物件",
        "邏輯集中在一個地方"
      ],
      "tags": ["business-logic", "domain-model"],
      "notes": "這符合物件導向的「品味」- 資料與行為內聚。",
      "linus_principle": "Good Taste - 好品味是讓邏輯自然內聚"
    },
    {
      "id": "1.5",
      "phase": "phase_1",
      "phase_name": "清理 Web-App 核心",
      "title": "為所有業務邏輯編寫單元測試 (TDD 紅-綠-重構)",
      "description": "為所有新的業務邏輯編寫單元測試。必須遵循 TDD 循環：1) 寫測試 2) 看它失敗（紅）3) 寫程式碼讓它通過（綠）4) 重構（藍）。目標：單元測試覆蓋率 > 80%。",
      "owner": "Backend + QA",
      "estimated_hours": 24,
      "actual_hours": 0,
      "status": "pending",
      "priority": "P0",
      "blocking": false,
      "target_date": "Week 4-5",
      "completed_date": null,
      "dependencies": ["1.4"],
      "blocked_by": [],
      "blocking_tasks": ["1.6"],
      "acceptance_criteria": [
        "單元測試覆蓋率 > 80%",
        "所有業務邏輯都有測試",
        "測試可獨立執行（不依賴資料庫）",
        "遵循 TDD 紅-綠-重構循環"
      ],
      "tags": ["testing", "tdd", "unit-test"],
      "notes": "這是品質保證的核心。沒有測試 = 沒有重構的勇氣。",
      "linus_principle": "A Test That Can't Fail Is Useless - 必須先看到失敗"
    },
    {
      "id": "1.6",
      "phase": "phase_1",
      "phase_name": "清理 Web-App 核心",
      "title": "驗證 API 契約測試全部通過 (零破壞檢查點)",
      "description": "Tech Lead 驗證 Phase 1 完成後，所有 API 契約測試仍然 100% 通過。這是出口檢查點，確認重構過程中沒有破壞任何 API。",
      "owner": "Tech Lead",
      "estimated_hours": 4,
      "actual_hours": 0,
      "status": "pending",
      "priority": "P0",
      "blocking": true,
      "target_date": "Week 5",
      "completed_date": null,
      "dependencies": ["1.5"],
      "blocked_by": [],
      "blocking_tasks": ["2.1"],
      "acceptance_criteria": [
        "API 契約測試 100% 通過",
        "單元測試覆蓋率 > 80%",
        "零 API 破壞",
        "Tech Lead 簽核"
      ],
      "tags": ["validation", "checkpoint", "api"],
      "notes": "Phase 1 的出口檢查點。確保 Never Break APIs 原則。",
      "linus_principle": "Never Break Userspace - API 就是我們的 Userspace"
    },

    {
      "id": "2.1",
      "phase": "phase_2",
      "phase_name": "清理 AI-Worker",
      "title": "統一 AI Task Pipeline 設計 (消除 Text/Voice 分支)",
      "description": "重新設計 AI Worker 的任務處理邏輯，使用策略模式統一 Text 和 Voice 任務的處理流程。Pipeline 統一為：[Input] -> [STT (optional)] -> [LLM+RAG] -> [TTS (optional)] -> [Output]。消除 if task.type == 'text' / 'voice' 的特殊情況分支。",
      "owner": "AI/ML",
      "estimated_hours": 12,
      "actual_hours": 0,
      "status": "pending",
      "priority": "P1",
      "blocking": false,
      "target_date": "Week 6",
      "completed_date": null,
      "dependencies": ["1.6"],
      "blocked_by": [],
      "blocking_tasks": ["2.2"],
      "acceptance_criteria": [
        "建立統一的 AITaskPipeline 類別",
        "使用 TaskStep 介面（STT, LLM, TTS 都實現此介面）",
        "消除 task.type 的條件分支",
        "Pipeline 可動態組合（Text: [LLM], Voice: [STT, LLM, TTS]）"
      ],
      "tags": ["ai-worker", "refactoring", "pipeline"],
      "notes": "參考 Linus 原則：Good Taste - 消除特殊情況。",
      "linus_principle": "Good Taste - 好程式碼沒有特殊情況"
    },
    {
      "id": "2.2",
      "phase": "phase_2",
      "phase_name": "清理 AI-Worker",
      "title": "重構 LLM+RAG 邏輯",
      "description": "將 LLM+RAG 的處理邏輯重構為獨立的 TaskStep。確保邏輯清晰、可測試、可替換（不同的 LLM 提供商）。",
      "owner": "AI/ML",
      "estimated_hours": 16,
      "actual_hours": 0,
      "status": "pending",
      "priority": "P1",
      "blocking": false,
      "target_date": "Week 6-7",
      "completed_date": null,
      "dependencies": ["2.1"],
      "blocked_by": [],
      "blocking_tasks": ["2.3"],
      "acceptance_criteria": [
        "LLMTaskStep 獨立實現",
        "RAG 檢索邏輯清晰分離",
        "可輕鬆切換不同 LLM 提供商",
        "單元測試覆蓋核心邏輯"
      ],
      "tags": ["ai-worker", "llm", "rag"],
      "notes": "確保 LLM 邏輯可測試（使用 Mock LLM）。",
      "linus_principle": "實用主義 - 可測試性比理論完美更重要"
    },
    {
      "id": "2.3",
      "phase": "phase_2",
      "phase_name": "清理 AI-Worker",
      "title": "重構 STT/TTS 整合",
      "description": "將 STT 和 TTS 的邏輯重構為獨立的 TaskStep。確保服務介面清晰，可輕鬆切換不同的 STT/TTS 提供商（OpenAI Whisper, Google STT 等）。",
      "owner": "AI/ML",
      "estimated_hours": 12,
      "actual_hours": 0,
      "status": "pending",
      "priority": "P1",
      "blocking": false,
      "target_date": "Week 7",
      "completed_date": null,
      "dependencies": ["2.2"],
      "blocked_by": [],
      "blocking_tasks": ["2.4"],
      "acceptance_criteria": [
        "STTTaskStep 獨立實現",
        "TTSTaskStep 獨立實現",
        "統一的音訊處理介面",
        "可切換不同服務提供商"
      ],
      "tags": ["ai-worker", "stt", "tts"],
      "notes": "為繁體中文 STT/TTS 的不穩定性預留備案。",
      "linus_principle": "解決實際問題 - 為實際風險（STT 準確率）做準備"
    },
    {
      "id": "2.4",
      "phase": "phase_2",
      "phase_name": "清理 AI-Worker",
      "title": "為 AI Worker 編寫單元測試",
      "description": "為 AI Worker 的核心邏輯編寫單元測試。使用 Mock 來隔離外部依賴（LLM API, STT/TTS 服務）。確保 Pipeline 邏輯、任務分派、錯誤處理都有測試覆蓋。",
      "owner": "AI/ML + QA",
      "estimated_hours": 16,
      "actual_hours": 0,
      "status": "pending",
      "priority": "P1",
      "blocking": false,
      "target_date": "Week 7-8",
      "completed_date": null,
      "dependencies": ["2.3"],
      "blocked_by": [],
      "blocking_tasks": ["3.1"],
      "acceptance_criteria": [
        "單元測試覆蓋率 > 70%",
        "Pipeline 邏輯測試完整",
        "使用 Mock 隔離外部依賴",
        "所有測試可獨立執行"
      ],
      "tags": ["testing", "ai-worker", "unit-test"],
      "notes": "AI Worker 測試重點是邏輯而非外部服務。",
      "linus_principle": "測試你能控制的，Mock 你不能控制的"
    },

    {
      "id": "3.1",
      "phase": "phase_3",
      "phase_name": "持續改進",
      "title": "程式碼品質檢查 (code-quality-specialist)",
      "description": "使用 code-quality-specialist 智能體進行全面的程式碼品質檢查。檢查項目包含：程式碼異味、重複代碼、圈複雜度、命名規範、注釋完整性等。生成改進建議清單。",
      "owner": "Code Quality Specialist Agent",
      "estimated_hours": 8,
      "actual_hours": 0,
      "status": "pending",
      "priority": "P2",
      "blocking": false,
      "target_date": "Week 8",
      "completed_date": null,
      "dependencies": ["2.4"],
      "blocked_by": [],
      "blocking_tasks": [],
      "acceptance_criteria": [
        "完整的程式碼品質報告",
        "識別所有關鍵技術債務",
        "提供具體改進建議",
        "優先級排序清單"
      ],
      "tags": ["code-quality", "subagent", "analysis"],
      "notes": "使用 /review-code 指令啟動智能體。",
      "linus_principle": "持續改進是工程師的責任"
    },
    {
      "id": "3.2",
      "phase": "phase_3",
      "phase_name": "持續改進",
      "title": "安全性稽核 (security-infrastructure-auditor)",
      "description": "使用 security-infrastructure-auditor 智能體進行安全性稽核。檢查項目包含：SQL 注入風險、XSS 風險、敏感資訊洩漏、認證漏洞、依賴套件漏洞等。生成安全報告與修復建議。",
      "owner": "Security Auditor Agent",
      "estimated_hours": 8,
      "actual_hours": 0,
      "status": "pending",
      "priority": "P1",
      "blocking": false,
      "target_date": "Week 8",
      "completed_date": null,
      "dependencies": ["2.4"],
      "blocked_by": [],
      "blocking_tasks": [],
      "acceptance_criteria": [
        "完整的安全稽核報告",
        "識別所有安全風險",
        "提供具體修復方案",
        "優先級排序（Critical/High/Medium/Low）"
      ],
      "tags": ["security", "subagent", "audit"],
      "notes": "使用 /hub-delegate security-infrastructure-auditor 指令。",
      "linus_principle": "安全是基本功，不是選項"
    },
    {
      "id": "3.3",
      "phase": "phase_3",
      "phase_name": "持續改進",
      "title": "效能優化 (如需要)",
      "description": "根據效能指標（API 回應時間、資料庫查詢效率、快取命中率等）進行必要的效能優化。包含：N+1 查詢優化、索引優化、快取策略調整等。",
      "owner": "Backend + AI/ML",
      "estimated_hours": 16,
      "actual_hours": 0,
      "status": "pending",
      "priority": "P2",
      "blocking": false,
      "target_date": "Week 9",
      "completed_date": null,
      "dependencies": ["2.4"],
      "blocked_by": [],
      "blocking_tasks": [],
      "acceptance_criteria": [
        "API P95 回應時間 < 500ms",
        "無明顯的 N+1 查詢",
        "快取策略合理",
        "資料庫索引優化"
      ],
      "tags": ["performance", "optimization"],
      "notes": "先測量，再優化。不做過早優化。",
      "linus_principle": "實用主義 - 只優化真正的瓶頸"
    },
    {
      "id": "3.4",
      "phase": "phase_3",
      "phase_name": "持續改進",
      "title": "文檔更新 (documentation-specialist)",
      "description": "使用 documentation-specialist 智能體更新所有相關文檔。包含：架構文件、API 文檔、重構總結、最佳實踐指南等。確保文檔與實際代碼一致。",
      "owner": "Documentation Specialist Agent",
      "estimated_hours": 8,
      "actual_hours": 0,
      "status": "pending",
      "priority": "P2",
      "blocking": false,
      "target_date": "Week 9",
      "completed_date": null,
      "dependencies": ["3.1", "3.2", "3.3"],
      "blocked_by": [],
      "blocking_tasks": [],
      "acceptance_criteria": [
        "架構文件更新完整",
        "API 文檔與代碼一致",
        "重構總結文件完成",
        "開發者指南更新"
      ],
      "tags": ["documentation", "subagent"],
      "notes": "使用 /hub-delegate documentation-specialist 指令。",
      "linus_principle": "好的文檔是工程師的責任，不是可選項"
    }
  ],
  "phase_summary": {
    "phase_0": {
      "name": "建立安全網 (Safety Net)",
      "tasks": 4,
      "hours": 48,
      "status": "pending",
      "blocking": true,
      "description": "此階段完成前，不允許任何重構"
    },
    "phase_1": {
      "name": "清理 Web-App 核心",
      "tasks": 6,
      "hours": 92,
      "status": "pending",
      "blocking": false,
      "description": "分離領域模型與 ORM，集中化業務邏輯"
    },
    "phase_2": {
      "name": "清理 AI-Worker",
      "tasks": 4,
      "hours": 56,
      "status": "pending",
      "blocking": false,
      "description": "統一 AI Pipeline，消除特殊情況分支"
    },
    "phase_3": {
      "name": "持續改進",
      "tasks": 4,
      "hours": 40,
      "status": "pending",
      "blocking": false,
      "description": "品質檢查、安全稽核、效能優化、文檔更新"
    }
  },
  "linus_principles_applied": {
    "data_structures_first": ["1.1", "1.2"],
    "never_break_apis": ["0.1", "0.2", "1.6"],
    "logic_in_one_place": ["1.4"],
    "write_tests_that_matter": ["0.2", "1.5", "2.4"],
    "good_taste": ["2.1"],
    "pragmatism": ["2.2", "2.3", "3.3"]
  }
}
