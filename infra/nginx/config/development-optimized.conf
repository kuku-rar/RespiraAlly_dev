# infra/nginx/config/development-optimized.conf
# 優化版開發環境 nginx 配置 - 直接服務靜態文件

# 上游服務定義
upstream web_app_upstream {
    server web-app:5000;
}

upstream minio_api_upstream {
    server minio:9000;
}

# 伺服器區塊: 處理 HTTP (Port 80) - 開發環境
server {
    listen 80;
    server_name localhost ${DOMAIN_NAME};

    # 安全標頭
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;

    # 靜態文件直接由 nginx 服務（核心修復）
    location ~* ^/(assets|js|css|images|fonts)/ {
        root /usr/share/nginx/html;
        
        # 長期快取靜態資源
        expires 1y;
        add_header Cache-Control "public, immutable";
        add_header X-Served-By "nginx-static";
        
        # 啟用 gzip 壓縮
        gzip_static on;
        
        # 如果文件不存在，返回 404 而不是轉發到 Flask
        try_files $uri =404;
        
        # 存取日誌（開發環境保留，生產環境可關閉）
        access_log /var/log/nginx/static.log;
    }

    # index.html 和其他 HTML 文件 - 不快取
    location ~* \.html$ {
        root /usr/share/nginx/html;
        expires -1;
        add_header Cache-Control "no-cache, no-store, must-revalidate";
        add_header Pragma "no-cache";
        add_header X-Served-By "nginx-html";
        
        try_files $uri =404;
    }

    # API 請求代理到 Flask 後端
    location /api/ {
        proxy_pass http://web_app_upstream;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # API 超時設定
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        
        # 檔案上傳大小限制
        client_max_body_size 20M;
        
        # 不快取 API 回應
        add_header Cache-Control "no-cache, no-store, must-revalidate";
    }

    # 語音API特殊配置 - 較長的超時時間
    location /api/v1/voice/ {
        proxy_pass http://web_app_upstream;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 語音處理需要較長時間
        proxy_connect_timeout 120s;
        proxy_send_timeout 120s;
        proxy_read_timeout 300s;
        
        # 音頻檔案上傳限制
        client_max_body_size 20M;
        
        # 上傳緩衝配置
        client_body_buffer_size 128k;
        proxy_buffering off;
    }

    # WebSocket 支援 (Flask-SocketIO)
    location /socket.io/ {
        proxy_pass http://web_app_upstream;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # WebSocket 特殊配置
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_cache_bypass $http_upgrade;
        
        # 長連接配置
        proxy_read_timeout 86400;
    }

    # Swagger 文檔代理到 Flask
    location /swagger/ {
        proxy_pass http://web_app_upstream;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # MinIO 儲存桶代理
    location /audio-bucket/ {
        proxy_pass http://minio_api_upstream;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # SPA 路由支援 - 優先嘗試靜態文件，失敗後轉發到 Flask
    location / {
        # 首先嘗試靜態文件
        root /usr/share/nginx/html;
        try_files $uri $uri/ @flask;
    }

    # Flask 後備處理器
    location @flask {
        proxy_pass http://web_app_upstream;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 添加標識，便於除錯
        add_header X-Served-By "flask-backend";
    }
}

# 錯誤頁面配置
error_page 404 /404.html;
error_page 500 502 503 504 /50x.html;

location = /404.html {
    root /usr/share/nginx/html;
    internal;
}

location = /50x.html {
    root /usr/share/nginx/html;
    internal;
}