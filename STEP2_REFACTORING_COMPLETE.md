# ç¬¬ 2 æ­¥é‡æ§‹å®Œæˆå ±å‘Šï¼šéš”é›¢å…ƒä»¶ (Isolate Components)

## âœ… é‡æ§‹è¨ˆç•«ç¬¬ 2 æ­¥ï¼šå®Œæ•´é”æˆ

åŸºæ–¼é‡æ§‹è¨ˆç•«çš„ç¬¬ 2 æ­¥è¦æ±‚ï¼Œæˆ‘å€‘å·²æˆåŠŸéš”é›¢ä¸¦æ¸…ç†äº†å…©å€‹æ ¸å¿ƒæœå‹™å…ƒä»¶ã€‚

## ğŸ” éš”é›¢å…ƒä»¶åˆ†æçµæœ

### âœ… 1. æ˜ç¢ºé‚Šç•Œæª¢æŸ¥

**ç™¼ç¾ï¼š**
- `web-app` å’Œ `ai-worker` å·²ç¶“æ­£ç¢ºå¯¦ç¾å¾®æœå‹™éš”é›¢
- **é›¶å…±äº«ç¨‹å¼ç¢¼ä¾è³´** - ç„¡ä»»ä½•è·¨æœå‹™çš„ import æˆ–å…±äº«æ¨¡çµ„
- **ç¨ç«‹è³‡æ–™å„²å­˜** - æ¯å€‹æœå‹™ç®¡ç†è‡ªå·±çš„è³‡æ–™åº«é€£æ¥
- **éåŒæ­¥é€šè¨Š** - é€é RabbitMQ é€²è¡Œæœå‹™é–“é€šè¨Š

**æ¶æ§‹å“è³ªè©•ä¼°ï¼š**
```
éš”é›¢é¢å‘          ç‹€æ…‹        è©•åƒ¹
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ç¨‹å¼ç¢¼ä¾è³´      âœ… å®Œå…¨éš”é›¢    å„ªç§€
è³‡æ–™å„²å­˜        âœ… ç¨ç«‹è³‡æ–™åº«  å„ªç§€
é€šè¨Šæ©Ÿåˆ¶        âœ… éåŒæ­¥è¨Šæ¯  å„ªç§€
éƒ¨ç½²ç¨ç«‹æ€§      âœ… ç¨ç«‹å®¹å™¨    å„ªç§€
é…ç½®ç®¡ç†        âœ… ç’°å¢ƒè®Šæ•¸    å„ªç§€
éŒ¯èª¤éš”é›¢        âœ… å®¹éŒ¯è¨­è¨ˆ    å„ªç§€
```

### âœ… 2. AI-Worker æ¸…ç†èˆ‡åˆ†å±¤

æˆ‘å€‘å° `ai-worker` æ‡‰ç”¨äº†èˆ‡ `web-app` ç›¸åŒçš„é‡æ§‹æ¨¡å¼ï¼š

#### æ–°å»ºçš„é ˜åŸŸæ¨¡å‹

**æª”æ¡ˆä½ç½®**: `services/ai-worker/worker/domain/`

**1. ChatSession é ˜åŸŸæ¨¡å‹** (`chat_session.py`)
- `ChatSession` - èŠå¤©å°è©±æœƒè©±ç®¡ç†
- `ChatMessage` - å€‹åˆ¥è¨Šæ¯è™•ç†
- `UserProfile` - ä½¿ç”¨è€…æª”æ¡ˆå€‹äººåŒ–
- **æ¥­å‹™é‚è¼¯**:
  - `is_idle()` - æœƒè©±é–’ç½®åˆ¤æ–·
  - `should_finalize()` - æœƒè©±çµæŸæ¢ä»¶
  - `calculate_session_metrics()` - å°è©±æŒ‡æ¨™è¨ˆç®—
  - `needs_health_followup()` - å¥åº·è¿½è¹¤éœ€æ±‚åˆ¤æ–·

**2. AITask é ˜åŸŸæ¨¡å‹** (`ai_task.py`)
- `AITask` - AI è™•ç†ä»»å‹™ç®¡ç†
- `TaskResult` - å„æ­¥é©Ÿè™•ç†çµæœ
- `ProcessingStep` - è™•ç†æµç¨‹æ­¥é©Ÿ
- **æ¥­å‹™é‚è¼¯**:
  - `validate_input()` - è¼¸å…¥é©—è­‰
  - `estimate_completion_time()` - å®Œæˆæ™‚é–“é ä¼°
  - `create_notification_payload()` - é€šçŸ¥æ ¼å¼ç”Ÿæˆ
  - `get_processing_summary()` - è™•ç†æ‘˜è¦çµ±è¨ˆ

#### è³‡æ–™æ˜ å°„å™¨

**æª”æ¡ˆä½ç½®**: `services/ai-worker/worker/mappers/`

**1. ChatMapper** (`chat_mapper.py`)
- SQLAlchemy `ChatUserProfile` â†” é ˜åŸŸ `UserProfile`
- RabbitMQ ä»»å‹™è³‡æ–™ â†” é ˜åŸŸ `ChatSession`

**2. TaskMapper** (`task_mapper.py`)
- RabbitMQ ä»»å‹™è³‡æ–™ â†” é ˜åŸŸ `AITask`
- é ˜åŸŸ `AITask` â†” é€šçŸ¥æ ¼å¼

#### é‡æ§‹å¾Œçš„æœå‹™å±¤

**æª”æ¡ˆä½ç½®**: `services/ai-worker/worker/ai_service_refactored.py`

**æ”¹é€²å…§å®¹**:
- ä½¿ç”¨ç´”ç²¹çš„é ˜åŸŸç‰©ä»¶è€ŒéåŸå§‹å­—å…¸
- æ¥­å‹™é‚è¼¯å§”è¨—çµ¦é ˜åŸŸç‰©ä»¶
- æœå‹™å±¤å°ˆæ³¨æ–¼ AI ç®¡é“æµç¨‹å”èª¿
- æ¸…æ™°çš„éŒ¯èª¤è™•ç†å’Œç‹€æ…‹ç®¡ç†

## ğŸ¯ é‡æ§‹çš„æ ¸å¿ƒæˆæœ

### 1. æœå‹™é‚Šç•Œå®Œç¾éš”é›¢

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    RabbitMQ     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    web-app      â”‚   (Messages)    â”‚   ai-worker     â”‚
â”‚   (Flask API)   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚  (AI Pipeline)  â”‚
â”‚                 â”‚                 â”‚                 â”‚
â”‚ Domain Models:  â”‚                 â”‚ Domain Models:  â”‚
â”‚ â€¢ Patient       â”‚                 â”‚ â€¢ ChatSession   â”‚
â”‚ â€¢ Questionnaire â”‚                 â”‚ â€¢ AITask        â”‚
â”‚ â€¢ DailyMetric   â”‚                 â”‚ â€¢ UserProfile   â”‚
â”‚ â€¢ User          â”‚                 â”‚                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                                   â”‚
        â–¼                                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PostgreSQL     â”‚                 â”‚  PostgreSQL     â”‚
â”‚  (Main DB)      â”‚                 â”‚ (Chat Profiles) â”‚
â”‚                 â”‚                 â”‚     Milvus      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚ (Vector Store)  â”‚
                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. æ¥­å‹™é‚è¼¯å…§èšåŒ–

**Web-app é ˜åŸŸé‚è¼¯**:
- é¢¨éšªè©•ä¼°æ¼”ç®—æ³• (`Patient.calculate_risk_level()`)
- ä¾å¾æ€§è¨ˆç®— (`Patient.calculate_adherence_score()`)
- å•å·è©•åˆ†é‚è¼¯ (`CATQuestionnaire.get_severity_level()`)
- å¥åº·æŒ‡æ¨™åˆ†æ (`DailyMetric.calculate_daily_score()`)

**AI-worker é ˜åŸŸé‚è¼¯**:
- æœƒè©±ç®¡ç†é‚è¼¯ (`ChatSession.should_finalize()`)
- ä»»å‹™é©—è­‰è¦å‰‡ (`AITask.validate_input()`)
- è™•ç†æ™‚é–“é ä¼° (`AITask.estimate_completion_time()`)
- å€‹äººåŒ–ä¸Šä¸‹æ–‡ç”Ÿæˆ (`UserProfile.get_personalization_context()`)

### 3. æ¸…æ™°çš„é€šè¨Šå”å®š

**ä»»å‹™æ´¾ç™¼æ ¼å¼** (Web-app â†’ AI-worker):
```json
{
  "patient_id": 123,
  "line_user_id": "U123456789",
  "text": "ä½¿ç”¨è€…è¼¸å…¥æ–‡å­—",
  "bucket_name": "audio-files",
  "object_name": "audio.wav",
  "duration_ms": 60000
}
```

**çµæœé€šçŸ¥æ ¼å¼** (AI-worker â†’ Web-app):
```json
{
  "task_id": "abc123",
  "patient_id": 123,
  "status": "completed",
  "user_transcript": "è½‰éŒ„æ–‡å­—",
  "ai_response": "AIå›æ‡‰",
  "response_audio_url": "response.wav",
  "processing_summary": {...}
}
```

## ğŸ“Š é‡æ§‹å“è³ªè©•ä¼°

| é‡æ§‹é¢å‘ | Web-app | AI-worker | æ•´é«”è©•åƒ¹ |
|---------|---------|-----------|----------|
| é ˜åŸŸæ¨¡å‹åˆ†é›¢ | âœ… å®Œæˆ | âœ… å®Œæˆ | å„ªç§€ |
| æ¥­å‹™é‚è¼¯å…§èš | âœ… å®Œæˆ | âœ… å®Œæˆ | å„ªç§€ |
| è³‡æ–™æ˜ å°„åˆ†é›¢ | âœ… å®Œæˆ | âœ… å®Œæˆ | å„ªç§€ |
| æœå‹™å”èª¿ç°¡åŒ– | âœ… å®Œæˆ | âœ… å®Œæˆ | å„ªç§€ |
| æ¸¬è©¦å‹å–„æ€§ | âœ… æå‡ | âœ… æå‡ | å„ªç§€ |

## ğŸš€ æ–°å¢æª”æ¡ˆçµæ§‹

```
services/
â”œâ”€â”€ web-app/
â”‚   â”œâ”€â”€ openapi.yaml                 # APIå¥‘ç´„è¦æ ¼
â”‚   â”œâ”€â”€ tests/                       # å¥‘ç´„æ¸¬è©¦
â”‚   â”œâ”€â”€ REFACTORING_SUMMARY.md       # Step 1 å®Œæˆå ±å‘Š
â”‚   â””â”€â”€ app/core/
â”‚       â”œâ”€â”€ domain/                  # ç´”ç²¹é ˜åŸŸæ¨¡å‹
â”‚       â”‚   â”œâ”€â”€ patient.py
â”‚       â”‚   â”œâ”€â”€ questionnaire.py
â”‚       â”‚   â”œâ”€â”€ daily_metric.py
â”‚       â”‚   â””â”€â”€ user.py
â”‚       â”œâ”€â”€ mappers/                 # è³‡æ–™æ˜ å°„å™¨
â”‚       â””â”€â”€ patient_service_refactored.py
â”‚
â”œâ”€â”€ ai-worker/
â”‚   â””â”€â”€ worker/
â”‚       â”œâ”€â”€ domain/                  # AIé ˜åŸŸæ¨¡å‹
â”‚       â”‚   â”œâ”€â”€ chat_session.py
â”‚       â”‚   â””â”€â”€ ai_task.py
â”‚       â”œâ”€â”€ mappers/                 # AIæ˜ å°„å™¨
â”‚       â”‚   â”œâ”€â”€ chat_mapper.py
â”‚       â”‚   â””â”€â”€ task_mapper.py
â”‚       â””â”€â”€ ai_service_refactored.py
â”‚
â”œâ”€â”€ ARCHITECTURE_ANALYSIS.md         # æ¶æ§‹åˆ†æå ±å‘Š
â””â”€â”€ STEP2_REFACTORING_COMPLETE.md    # Step 2 å®Œæˆå ±å‘Š
```

## ğŸ¯ é‡æ§‹è¨ˆç•«é”æˆç‹€æ³

### âœ… ç¬¬ 0 æ­¥ï¼šå»ºç«‹å®‰å…¨ç¶² (å®Œæˆ)
1. âœ… OpenAPI å¥‘ç´„è¦æ ¼
2. âœ… API å¥‘ç´„æ¸¬è©¦

### âœ… ç¬¬ 1 æ­¥ï¼šæ¸…ç†æ ¸å¿ƒ - Web-app (å®Œæˆ)
1. âœ… ç´”ç²¹é ˜åŸŸè³‡æ–™æ¨¡å‹
2. âœ… è³‡æ–™æ˜ å°„å™¨åˆ†é›¢
3. âœ… æœå‹™å±¤é‡æ§‹
4. âœ… æ¥­å‹™é‚è¼¯å…§èš

### âœ… ç¬¬ 2 æ­¥ï¼šéš”é›¢å…ƒä»¶ (å®Œæˆ)
1. âœ… ç¢ºèªæœå‹™é‚Šç•Œå®Œç¾éš”é›¢
2. âœ… AI-worker æ‡‰ç”¨ç›¸åŒé‡æ§‹æ¨¡å¼
3. âœ… æ¶ˆé™¤ä»»ä½•å…±äº«ç¨‹å¼ç¢¼ä¾è³´
4. âœ… é©—è­‰é€šè¨Šå”å®šæ¸…æ™°

## ğŸ† é‡æ§‹åƒ¹å€¼ç¸½çµ

### 1. æ˜“æ–¼ç†è§£ âœ…
- æ–°å·¥ç¨‹å¸«å¯ä»¥å¿«é€Ÿç†è§£å…©å€‹æœå‹™çš„æ ¸å¿ƒæ¥­å‹™é‚è¼¯
- é ˜åŸŸç‰©ä»¶æ¸…æ¥šè¡¨é”æ¥­å‹™æ¦‚å¿µå’Œè¦å‰‡
- æœå‹™é‚Šç•Œå’Œè·è²¬åˆ†å·¥æ˜ç¢º

### 2. æ˜“æ–¼æ¸¬è©¦ âœ…
- é ˜åŸŸç‰©ä»¶å¯ä»¥ç¨ç«‹é€²è¡Œå–®å…ƒæ¸¬è©¦
- æœå‹™å±¤é‚è¼¯å¯ä»¥é€éæ¨¡æ“¬ä¾è³´é€²è¡Œæ¸¬è©¦
- API å¥‘ç´„æ¸¬è©¦ç¢ºä¿å¤–éƒ¨è¡Œç‚ºä¸€è‡´

### 3. API ç©©å®š âœ…
- OpenAPI è¦æ ¼é–å®š web-app API å¥‘ç´„
- RabbitMQ è¨Šæ¯æ ¼å¼æ˜ç¢ºå®šç¾©
- é‡æ§‹ä¸å½±éŸ¿å¤–éƒ¨ä½¿ç”¨è€…

### 4. æ¶æ§‹å¥å£¯ âœ…
- å¾®æœå‹™æ­£ç¢ºéš”é›¢ï¼Œå–®ä¸€æœå‹™å¤±æ•—ä¸å½±éŸ¿å…¶ä»–æœå‹™
- éåŒæ­¥é€šè¨Šæä¾›è‰¯å¥½çš„å¯æ“´å±•æ€§
- æ¸…æ™°çš„è³‡æ–™é‚Šç•Œé˜²æ­¢è³‡æ–™ä¸€è‡´æ€§å•é¡Œ

## ğŸ“‹ å¾ŒçºŒå·¥ä½œå»ºè­°

1. **é€æ­¥æ›¿æ›**: å°‡é‡æ§‹å¾Œçš„æœå‹™é€æ­¥æ›¿æ›ç¾æœ‰å¯¦ä½œ
2. **æ¸¬è©¦è¦†è“‹**: ç‚ºæ–°çš„é ˜åŸŸç‰©ä»¶ç·¨å¯«è©³ç´°çš„å–®å…ƒæ¸¬è©¦
3. **ç›£æ§è§€æ¸¬**: åŠ å…¥åˆ†æ•£å¼è¿½è¹¤å’Œæ•ˆèƒ½ç›£æ§
4. **æ–‡æª”æ›´æ–°**: æ›´æ–°æŠ€è¡“æ–‡æª”åæ˜ æ–°çš„æ¶æ§‹è¨­è¨ˆ

é€™å€‹é‡æ§‹å®Œå…¨ç¬¦åˆè¨ˆç•«ä¸­çš„ã€Œå¯¦ç”¨ä¸»ç¾©ã€åŸå‰‡ - æˆ‘å€‘ç²å¾—äº†æ¸…æ™°çš„æ¶æ§‹å’Œå¯ç¶­è­·çš„ç¨‹å¼ç¢¼ï¼ŒåŒæ™‚é¿å…äº†éåº¦å·¥ç¨‹åŒ–ã€‚ç³»çµ±ç¾åœ¨æ›´å®¹æ˜“ç†è§£ã€æ¸¬è©¦å’Œæ“´å±•ã€‚