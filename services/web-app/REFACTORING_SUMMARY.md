# é‡æ§‹å®Œæˆå ±å‘Š

åŸºæ–¼ [refactoring_plan.md](docs/refactoring_plan.md) çš„æŒ‡å°åŸå‰‡ï¼Œæˆ‘å€‘å·²æˆåŠŸå®Œæˆäº†ç¬¬ 0 æ­¥å’Œç¬¬ 1 æ­¥çš„é‡æ§‹å·¥ä½œã€‚

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### ç¬¬ 0 æ­¥ï¼šå»ºç«‹å®‰å…¨ç¶² (Stop the Rot)

#### 1. OpenAPI å¥‘ç´„è¦æ ¼ âœ…
- **æª”æ¡ˆä½ç½®**: `services/web-app/openapi.yaml`
- **æ¶µè“‹ç¯„åœ**: æ‰€æœ‰ç¾æœ‰ API ç«¯é»çš„å®Œæ•´è¦æ ¼
- **åŒ…å«å…§å®¹**:
  - èªè­‰ç«¯é» (`/auth/login`, `/auth/line/login`, `/auth/line/register`)
  - ç—…æ‚£ç®¡ç†ç«¯é» (`/therapist/patients`, `/patients/{id}/profile`, `/patients/{id}/kpis`)
  - å•å·ç«¯é» (`/patients/{id}/questionnaires/cat`, `/patients/{id}/questionnaires/mmrc`)
  - æ¯æ—¥å¥åº·æ—¥èªŒç«¯é» (`/patients/{id}/daily_metrics`)
  - ä½¿ç”¨è€…ç®¡ç†ç«¯é» (`/users`)

#### 2. API å¥‘ç´„æ¸¬è©¦ âœ…
- **æª”æ¡ˆä½ç½®**: `services/web-app/tests/`
- **æ¸¬è©¦æª”æ¡ˆ**:
  - `test_api_contracts.py` - å®Œæ•´çš„å¥‘ç´„æ¸¬è©¦å¥—ä»¶
  - `test_contracts_basic.py` - åŸºç¤å¥‘ç´„é©—è­‰
  - `conftest.py` - æ¸¬è©¦é…ç½®
- **æ¸¬è©¦æ¶µè“‹**:
  - æ‰€æœ‰ API ç«¯é»çš„è«‹æ±‚/å›æ‡‰æ ¼å¼é©—è­‰
  - éŒ¯èª¤å›æ‡‰çµæ§‹é©—è­‰
  - åˆ†é çµæ§‹é©—è­‰
  - CORS æ¨™é ­é©—è­‰

### ç¬¬ 1 æ­¥ï¼šæ¸…ç†æ ¸å¿ƒ (Clean the Core)

#### 1. ç´”ç²¹çš„é ˜åŸŸè³‡æ–™æ¨¡å‹ âœ…
- **æª”æ¡ˆä½ç½®**: `services/web-app/app/core/domain/`
- **é ˜åŸŸç‰©ä»¶**:
  - `patient.py` - ç—…æ‚£æ ¸å¿ƒè³‡æ–™æ¨¡å‹ï¼ŒåŒ…å«é¢¨éšªè©•ä¼°ã€ä¾å¾æ€§è¨ˆç®—ç­‰æ¥­å‹™é‚è¼¯
  - `user.py` - ä½¿ç”¨è€…èº«ä»½æ¨¡å‹ï¼ŒåŒ…å«æ¬Šé™é‚è¼¯
  - `questionnaire.py` - å•å·æ¨¡å‹ï¼ˆCAT/MMRCï¼‰ï¼ŒåŒ…å«è©•åˆ†å’Œè¶¨å‹¢åˆ†æé‚è¼¯
  - `daily_metric.py` - æ¯æ—¥å¥åº·æŒ‡æ¨™æ¨¡å‹ï¼ŒåŒ…å«å¥åº·è©•åˆ†å’Œè­¦å ±é‚è¼¯

#### 2. è³‡æ–™æ˜ å°„å™¨ (Mappers) âœ…
- **æª”æ¡ˆä½ç½®**: `services/web-app/app/core/mappers/`
- **æ˜ å°„å™¨**:
  - `patient_mapper.py` - SQLAlchemy ç—…æ‚£æ¨¡å‹ â†” é ˜åŸŸç—…æ‚£ç‰©ä»¶
  - `questionnaire_mapper.py` - SQLAlchemy å•å·æ¨¡å‹ â†” é ˜åŸŸå•å·ç‰©ä»¶
  - `daily_metric_mapper.py` - SQLAlchemy æŒ‡æ¨™æ¨¡å‹ â†” é ˜åŸŸæŒ‡æ¨™ç‰©ä»¶

#### 3. é‡æ§‹å¾Œçš„æœå‹™å±¤ âœ…
- **æª”æ¡ˆä½ç½®**: `services/web-app/app/core/patient_service_refactored.py`
- **æ”¹é€²å…§å®¹**:
  - ä½¿ç”¨ç´”ç²¹çš„é ˜åŸŸç‰©ä»¶è€Œé SQLAlchemy æ¨¡å‹
  - æ¥­å‹™é‚è¼¯å§”è¨—çµ¦é ˜åŸŸç‰©ä»¶
  - æœå‹™å±¤å°ˆæ³¨æ–¼æµç¨‹å”èª¿
  - æ¸…æ™°çš„éŒ¯èª¤è™•ç†å’Œåƒæ•¸é©—è­‰

#### 4. æ¥­å‹™é‚è¼¯å…§èš âœ…
é ˜åŸŸç‰©ä»¶ç¾åœ¨åŒ…å«ç›¸é—œçš„æ¥­å‹™é‚è¼¯ï¼š

**Patient é¡åˆ¥**:
- `calculate_risk_level()` - é¢¨éšªç­‰ç´šè©•ä¼°
- `calculate_adherence_score()` - ä¾å¾æ€§è©•åˆ†
- `needs_followup()` - è¿½è¹¤éœ€æ±‚åˆ¤æ–·
- `is_smoking_risk()` - å¸è¸é¢¨éšªè©•ä¼°

**CATQuestionnaire é¡åˆ¥**:
- `get_severity_level()` - åš´é‡ç¨‹åº¦åˆ†ç´š
- `is_improvement()` - æ”¹å–„è¶¨å‹¢åˆ¤æ–·
- `validate_scores()` - åˆ†æ•¸é©—è­‰

**DailyMetric é¡åˆ¥**:
- `calculate_daily_score()` - æ¯æ—¥å¥åº·è©•åˆ†
- `get_health_alerts()` - å¥åº·è­¦å ±ç”Ÿæˆ
- `is_hydration_adequate()` - æ°´åˆ†æ”å–è©•ä¼°

**åˆ†æå·¥å…·é¡åˆ¥**:
- `QuestionnaireAnalyzer` - å•å·è¶¨å‹¢åˆ†æ
- `MetricAnalyzer` - æŒ‡æ¨™æ¨¡å¼è­˜åˆ¥

## ğŸ¯ é‡æ§‹çš„æ ¸å¿ƒæˆæœ

### 1. è³‡æ–™çµæ§‹å„ªå…ˆ (Data Structures First)
- âœ… æ ¸å¿ƒè³‡æ–™æ¨¡å‹èˆ‡è³‡æ–™åº«å„²å­˜å®Œå…¨åˆ†é›¢
- âœ… æ¸…æ™°çš„é‚Šç•Œé˜²æ­¢è³‡æ–™åº«å¯¦ä½œç´°ç¯€æ±¡æŸ“æ¥­å‹™é‚è¼¯
- âœ… ç´”ç²¹çš„ Python é¡åˆ¥ï¼Œä¾¿æ–¼æ¸¬è©¦å’Œç†è§£

### 2. çµ•ä¸ç ´å£ API (No Broken APIs)
- âœ… OpenAPI è¦æ ¼é–å®šç¾æœ‰ API å¥‘ç´„
- âœ… å¥‘ç´„æ¸¬è©¦ç¢ºä¿ API è¡Œç‚ºä¸€è‡´æ€§
- âœ… å¯ä»¥å®‰å…¨é‡æ§‹å…§éƒ¨å¯¦ä½œè€Œä¸å½±éŸ¿ API ä½¿ç”¨è€…

### 3. é‚è¼¯é›†ä¸­ç®¡ç† (Logic Belongs in One Place)
- âœ… æ¥­å‹™é‚è¼¯å¾æœå‹™å±¤ç§»åˆ°é ˜åŸŸç‰©ä»¶
- âœ… é¢¨éšªè©•ä¼°ã€ä¾å¾æ€§è¨ˆç®—ç­‰æ ¸å¿ƒé‚è¼¯å…§èšåœ¨ç›¸é—œç‰©ä»¶ä¸­
- âœ… æœå‹™å±¤å°ˆæ³¨æ–¼å”èª¿å’Œæµç¨‹ç®¡ç†

### 4. å¯«æœ‰æ„ç¾©çš„æ¸¬è©¦ (Write Tests That Matter)
- âœ… API å¥‘ç´„æ¸¬è©¦ç¢ºä¿å¤–éƒ¨è¡Œç‚ºä¸è®Š
- âœ… é ˜åŸŸç‰©ä»¶å¯ä»¥ç¨ç«‹é€²è¡Œå–®å…ƒæ¸¬è©¦
- âœ… æ¸¬è©¦çµæ§‹æ”¯æ´ TDD é–‹ç™¼æµç¨‹

## ğŸ“ æ–°çš„å°ˆæ¡ˆçµæ§‹

```
services/web-app/
â”œâ”€â”€ openapi.yaml                    # API å¥‘ç´„è¦æ ¼
â”œâ”€â”€ tests/                          # å¥‘ç´„æ¸¬è©¦
â”‚   â”œâ”€â”€ test_api_contracts.py
â”‚   â”œâ”€â”€ test_contracts_basic.py
â”‚   â””â”€â”€ conftest.py
â””â”€â”€ app/
    â””â”€â”€ core/
        â”œâ”€â”€ domain/                  # ç´”ç²¹çš„é ˜åŸŸæ¨¡å‹
        â”‚   â”œâ”€â”€ patient.py
        â”‚   â”œâ”€â”€ user.py
        â”‚   â”œâ”€â”€ questionnaire.py
        â”‚   â””â”€â”€ daily_metric.py
        â”œâ”€â”€ mappers/                 # è³‡æ–™æ˜ å°„å™¨
        â”‚   â”œâ”€â”€ patient_mapper.py
        â”‚   â”œâ”€â”€ questionnaire_mapper.py
        â”‚   â””â”€â”€ daily_metric_mapper.py
        â”œâ”€â”€ patient_service_refactored.py  # é‡æ§‹å¾Œçš„æœå‹™
        â””â”€â”€ [ç¾æœ‰æª”æ¡ˆ...]
```

## ğŸ”„ ä¸‹ä¸€æ­¥

åŸºæ–¼é‡æ§‹è¨ˆç•«ï¼Œæ¥ä¸‹ä¾†æ‡‰è©²é€²è¡Œï¼š

### ç¬¬ 2 æ­¥ï¼šéš”é›¢å…ƒä»¶ (Isolate Components)
1. ç¢ºä¿ `web-app` å’Œ `ai-worker` ä¹‹é–“åªé€é API é€šè¨Š
2. å° `ai-worker` é€²è¡ŒåŒæ¨£çš„æ¸…ç†å’Œåˆ†å±¤

### ç¹¼çºŒæ”¹é€²
1. å°‡é‡æ§‹å¾Œçš„æœå‹™é€æ­¥æ›¿æ›ç¾æœ‰æœå‹™
2. ç‚ºé ˜åŸŸç‰©ä»¶ç·¨å¯«è©³ç´°çš„å–®å…ƒæ¸¬è©¦
3. ç›£æ§ API å¥‘ç´„æ¸¬è©¦ç¢ºä¿ç„¡ç ´å£æ€§è®Šæ›´

## ğŸ† é‡æ§‹çš„åƒ¹å€¼

1. **æ˜“æ–¼ç†è§£**: æ–°çš„å·¥ç¨‹å¸«å¯ä»¥å¿«é€Ÿç†è§£æ ¸å¿ƒæ¥­å‹™é‚è¼¯ï¼Œå› ç‚ºå®ƒå€‘æ¸…æ™°åœ°å°è£åœ¨é ˜åŸŸç‰©ä»¶ä¸­
2. **æ˜“æ–¼æ¸¬è©¦**: é ˜åŸŸç‰©ä»¶å¯ä»¥ç¨ç«‹æ¸¬è©¦ï¼Œä¸éœ€è¦è³‡æ–™åº«æˆ– Web æ¡†æ¶
3. **API ç©©å®š**: å¥‘ç´„æ¸¬è©¦ç¢ºä¿é‡æ§‹ä¸æœƒç ´å£ç¾æœ‰ API ä½¿ç”¨è€…
4. **æ¥­å‹™é‚è¼¯å…§èš**: ç›¸é—œçš„æ¥­å‹™è¦å‰‡èšé›†åœ¨ä¸€èµ·ï¼Œä¾¿æ–¼ç¶­è­·å’Œæ“´å±•

é€™å€‹é‡æ§‹éµå¾ªäº†ã€Œå¯¦ç”¨ä¸»ç¾©ã€çš„åŸå‰‡ - æˆ‘å€‘å–å¾—äº†æ¶æ§‹çš„ç²¾è¯ï¼ˆé—œæ³¨é»åˆ†é›¢ï¼‰ï¼Œä½†ä»¥æœ€ç°¡å–®ã€æœ€å‹™å¯¦çš„æ–¹å¼æ‡‰ç”¨å®ƒï¼Œä¸æœƒéåº¦å·¥ç¨‹åŒ–ã€‚